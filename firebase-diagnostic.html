<!DOCTYPE html>
<html lang="ru">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>üîß Firebase –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        max-width: 900px;
        margin: 20px auto;
        padding: 20px;
        background: #f5f5f5;
      }
      .panel {
        background: white;
        padding: 20px;
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        margin-bottom: 20px;
      }
      .status {
        padding: 12px;
        border-radius: 6px;
        margin: 10px 0;
        font-weight: bold;
      }
      .success {
        background: #d4edda;
        color: #155724;
        border-left: 4px solid #28a745;
      }
      .error {
        background: #f8d7da;
        color: #721c24;
        border-left: 4px solid #dc3545;
      }
      .warning {
        background: #fff3cd;
        color: #856404;
        border-left: 4px solid #ffc107;
      }
      .info {
        background: #d1ecf1;
        color: #0c5460;
        border-left: 4px solid #17a2b8;
      }

      button {
        background: #007bff;
        color: white;
        border: none;
        padding: 12px 24px;
        border-radius: 6px;
        cursor: pointer;
        margin: 8px;
        font-size: 14px;
      }
      button:hover {
        background: #0056b3;
      }
      button:disabled {
        background: #6c757d;
        cursor: not-allowed;
      }

      .step {
        background: #f8f9fa;
        border: 1px solid #dee2e6;
        padding: 15px;
        border-radius: 6px;
        margin: 10px 0;
      }
      .step h4 {
        margin-top: 0;
        color: #495057;
      }

      .code-block {
        background: #f1f3f4;
        border: 1px solid #dadce0;
        border-radius: 4px;
        padding: 12px;
        font-family: "Courier New", monospace;
        font-size: 13px;
        overflow-x: auto;
      }

      #log {
        background: #2d3748;
        color: #e2e8f0;
        border-radius: 6px;
        padding: 15px;
        max-height: 400px;
        overflow-y: auto;
        font-family: "Courier New", monospace;
        font-size: 12px;
      }

      .alert {
        padding: 15px;
        border-radius: 6px;
        margin: 15px 0;
      }
      .alert-danger {
        background: #f8d7da;
        border: 1px solid #f5c6cb;
        color: #721c24;
      }
    </style>
  </head>
  <body>
    <h1>üîß Firebase –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –∏ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ</h1>

    <div class="alert alert-danger">
      <strong>‚ö†Ô∏è –ü–†–û–ë–õ–ï–ú–ê –ù–ê–ô–î–ï–ù–ê!</strong><br />
      –í Firebase —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã –ø—Ä–∞–≤–∏–ª–∞, –∫–æ—Ç–æ—Ä—ã–µ
      <strong>–ø–æ–ª–Ω–æ—Å—Ç—å—é –±–ª–æ–∫–∏—Ä—É—é—Ç –¥–æ—Å—Ç—É–ø</strong>:<br />
      <code>{ "rules": { ".read": false, ".write": false } }</code>
    </div>

    <div class="panel">
      <h3>üìã –ü–æ—à–∞–≥–æ–≤–æ–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ</h3>

      <div class="step">
        <h4>–®–∞–≥ 1: –û—Ç–∫—Ä–æ–π—Ç–µ Firebase Console</h4>
        <p>
          –ü–µ—Ä–µ–π–¥–∏—Ç–µ –Ω–∞
          <a href="https://console.firebase.google.com" target="_blank"
            >https://console.firebase.google.com</a
          >
        </p>
        <p>–í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–æ–µ–∫—Ç <strong>"my-bud≈ºet"</strong></p>
      </div>

      <div class="step">
        <h4>–®–∞–≥ 2: –ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ Realtime Database</h4>
        <p>
          –í –ª–µ–≤–æ–º –º–µ–Ω—é –Ω–∞–π–¥–∏—Ç–µ <strong>"Realtime Database"</strong> –∏ –Ω–∞–∂–º–∏—Ç–µ –Ω–∞
          –Ω–µ–≥–æ
        </p>
      </div>

      <div class="step">
        <h4>–®–∞–≥ 3: –û—Ç–∫—Ä–æ–π—Ç–µ Rules (–ü—Ä–∞–≤–∏–ª–∞)</h4>
        <p>
          –í –≤–µ—Ä—Ö–Ω–µ–π —á–∞—Å—Ç–∏ —ç–∫—Ä–∞–Ω–∞ –Ω–∞–∂–º–∏—Ç–µ –Ω–∞ –≤–∫–ª–∞–¥–∫—É <strong>"Rules"</strong>
        </p>
      </div>

      <div class="step">
        <h4>–®–∞–≥ 4: –ó–∞–º–µ–Ω–∏—Ç–µ –ø—Ä–∞–≤–∏–ª–∞</h4>
        <p>–£–¥–∞–ª–∏—Ç–µ –í–°–ï —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –ø—Ä–∞–≤–∏–ª–∞ –∏ –≤—Å—Ç–∞–≤—å—Ç–µ —ç—Ç–∏:</p>
        <div class="code-block">
          { "rules": { "budgets": { "$userId": { ".read": "auth != null &&
          auth.uid == $userId", ".write": "auth != null && auth.uid == $userId",
          ".validate": "newData.hasChildren(['data', 'lastModified',
          'version'])" } } } }
        </div>
      </div>

      <div class="step">
        <h4>–®–∞–≥ 5: –û–ø—É–±–ª–∏–∫—É–π—Ç–µ –ø—Ä–∞–≤–∏–ª–∞</h4>
        <p>–ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É <strong>"Publish"</strong> (–û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å)</p>
        <p>–î–æ–∂–¥–∏—Ç–µ—Å—å —Å–æ–æ–±—â–µ–Ω–∏—è –æ–± —É—Å–ø–µ—à–Ω–æ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏</p>
      </div>
    </div>

    <div class="panel">
      <h3>üß™ –î–∏–∞–≥–Ω–æ—Å—Ç–∏—á–µ—Å–∫–∏–µ —Ç–µ—Å—Ç—ã</h3>
      <div id="mainStatus" class="status info">–ì–æ—Ç–æ–≤ –∫ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—é...</div>

      <button onclick="runFullDiagnostic()">üîç –ü–æ–ª–Ω–∞—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞</button>
      <button onclick="testCurrentRules()">üìã –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø—Ä–∞–≤–∏–ª–∞</button>
      <button onclick="testWithNewRules()">‚úÖ –¢–µ—Å—Ç —Å –Ω–æ–≤—ã–º–∏ –ø—Ä–∞–≤–∏–ª–∞–º–∏</button>
      <button onclick="clearLog()">üßπ –û—á–∏—Å—Ç–∏—Ç—å –ª–æ–≥</button>

      <h4>üìù –õ–æ–≥ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏:</h4>
      <div id="log"></div>
    </div>

    <!-- Firebase Scripts -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

    <script>
      // Firebase –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
      const firebaseConfig = {
        apiKey: "ATZaEVeSSGtLRpQq7e_ZQKPjOZkRq-YRKOpSjE",
        authDomain: "my-bud≈ºet.firebaseapp.com",
        databaseURL:
          "https://my-bud≈ºet-default-rtdb.europe-west1.firebasedatabase.app",
        projectId: "my-bud≈ºet",
        storageBucket: "my-bud≈ºet.firebasestorage.app",
        messagingSenderId: "38303046323",
        appId: "1:38303046323:web:e60dbad863a6db92c6",
        measurementId: "G-3SWHMH2ZF8",
      };

      let app, auth, database;
      let currentUser = null;

      function log(message, type = "info") {
        const logElement = document.getElementById("log");
        const timestamp = new Date().toLocaleTimeString();
        const colors = {
          error: "#ff6b6b",
          success: "#51cf66",
          warning: "#ffd43b",
          info: "#74c0fc",
        };

        const logEntry = `<div style="color: ${
          colors[type] || colors.info
        }; margin-bottom: 5px;">
                [${timestamp}] ${message}
            </div>`;

        logElement.innerHTML += logEntry;
        logElement.scrollTop = logElement.scrollHeight;
        console.log(`[${timestamp}] ${message}`);
      }

      function updateMainStatus(message, type) {
        const statusElement = document.getElementById("mainStatus");
        statusElement.textContent = message;
        statusElement.className = `status ${type}`;
      }

      async function initializeFirebase() {
        try {
          if (!firebase.apps.length) {
            app = firebase.initializeApp(firebaseConfig);
          }
          auth = firebase.auth();
          database = firebase.database();
          return true;
        } catch (error) {
          log(`‚ùå –û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ Firebase: ${error.message}`, "error");
          return false;
        }
      }

      async function testCurrentRules() {
        log("üîç –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–µ–∫—É—â–∏–µ –ø—Ä–∞–≤–∏–ª–∞ Firebase...", "info");

        if (!(await initializeFirebase())) {
          updateMainStatus("–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ Firebase", "error");
          return;
        }

        try {
          // –ü–æ–ø—ã—Ç–∫–∞ —á—Ç–µ–Ω–∏—è –±–µ–∑ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏
          log("üìñ –¢–µ—Å—Ç —á—Ç–µ–Ω–∏—è –±–µ–∑ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏...", "info");
          const testRef = database.ref("test-connection");
          await testRef.once("value");
          log("‚úÖ –ß—Ç–µ–Ω–∏–µ –±–µ–∑ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ —Ä–∞–∑—Ä–µ—à–µ–Ω–æ", "success");
        } catch (error) {
          log(
            `‚ùå –ß—Ç–µ–Ω–∏–µ –±–µ–∑ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–æ: ${error.message}`,
            "error"
          );

          if (error.code === "PERMISSION_DENIED") {
            log("üîí –≠—Ç–æ –æ–∑–Ω–∞—á–∞–µ—Ç, —á—Ç–æ –ø—Ä–∞–≤–∏–ª–∞ –±–ª–æ–∫–∏—Ä—É—é—Ç –¥–æ—Å—Ç—É–ø", "warning");
            updateMainStatus(
              "–ü—Ä–∞–≤–∏–ª–∞ –±–ª–æ–∫–∏—Ä—É—é—Ç –¥–æ—Å—Ç—É–ø - –Ω—É–∂–Ω–æ –∏—Ö –æ–±–Ω–æ–≤–∏—Ç—å!",
              "error"
            );
          }
        }

        try {
          // –ü–æ–ø—ã—Ç–∫–∞ –∑–∞–ø–∏—Å–∏ –±–µ–∑ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏
          log("‚úèÔ∏è –¢–µ—Å—Ç –∑–∞–ø–∏—Å–∏ –±–µ–∑ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏...", "info");
          const testRef = database.ref("test-write");
          await testRef.set({ test: true });
          log("‚úÖ –ó–∞–ø–∏—Å—å –±–µ–∑ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ —Ä–∞–∑—Ä–µ—à–µ–Ω–∞", "success");
        } catch (error) {
          log(
            `‚ùå –ó–∞–ø–∏—Å—å –±–µ–∑ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–∞: ${error.message}`,
            "error"
          );
        }
      }

      async function testWithNewRules() {
        log(
          "üß™ –¢–µ—Å—Ç–∏—Ä—É–µ–º —Å –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–µ–π (–∫–∞–∫ –±—É–¥–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å —Å –Ω–æ–≤—ã–º–∏ –ø—Ä–∞–≤–∏–ª–∞–º–∏)...",
          "info"
        );

        if (!(await initializeFirebase())) {
          updateMainStatus("–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ Firebase", "error");
          return;
        }

        try {
          // –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è
          log("üîë –í—ã–ø–æ–ª–Ω—è–µ–º –∞–Ω–æ–Ω–∏–º–Ω—É—é –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—é...", "info");
          const userCredential = await auth.signInAnonymously();
          currentUser = userCredential.user;
          log(
            `‚úÖ –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞. User ID: ${currentUser.uid}`,
            "success"
          );

          // –¢–µ—Å—Ç –∑–∞–ø–∏—Å–∏ —Å –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–µ–π
          log("‚úèÔ∏è –¢–µ—Å—Ç –∑–∞–ø–∏—Å–∏ —Å –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–µ–π...", "info");
          const userData = {
            data: { test: true, timestamp: new Date().toISOString() },
            lastModified: firebase.database.ServerValue.TIMESTAMP,
            version: "1.0.0",
          };

          await database.ref(`budgets/${currentUser.uid}`).set(userData);
          log("‚úÖ –ó–∞–ø–∏—Å—å —Å –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–µ–π —É—Å–ø–µ—à–Ω–∞!", "success");

          // –¢–µ—Å—Ç —á—Ç–µ–Ω–∏—è —Å –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–µ–π
          log("üìñ –¢–µ—Å—Ç —á—Ç–µ–Ω–∏—è —Å –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–µ–π...", "info");
          const snapshot = await database
            .ref(`budgets/${currentUser.uid}`)
            .once("value");

          if (snapshot.exists()) {
            log("‚úÖ –ß—Ç–µ–Ω–∏–µ —Å –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–µ–π —É—Å–ø–µ—à–Ω–æ!", "success");
            log(
              `üìä –î–∞–Ω–Ω—ã–µ: ${JSON.stringify(snapshot.val(), null, 2)}`,
              "info"
            );
            updateMainStatus(
              "Firebase —Ä–∞–±–æ—Ç–∞–µ—Ç –ø—Ä–∞–≤–∏–ª—å–Ω–æ —Å –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–µ–π!",
              "success"
            );
          } else {
            log("‚ö†Ô∏è –î–∞–Ω–Ω—ã–µ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã", "warning");
          }
        } catch (error) {
          log(
            `‚ùå –û—à–∏–±–∫–∞ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —Å –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–µ–π: ${error.message}`,
            "error"
          );

          if (error.code === "PERMISSION_DENIED") {
            log("üîí –î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â–µ–Ω - –ø—Ä–æ–≤–µ—Ä—å—Ç–µ –ø—Ä–∞–≤–∏–ª–∞ Firebase!", "error");
            updateMainStatus("–î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â–µ–Ω - –æ–±–Ω–æ–≤–∏—Ç–µ –ø—Ä–∞–≤–∏–ª–∞!", "error");
          }
        }
      }

      async function runFullDiagnostic() {
        log("üöÄ –ó–∞–ø—É—Å–∫ –ø–æ–ª–Ω–æ–π –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏ Firebase...", "info");
        log("=".repeat(50), "info");

        updateMainStatus("–í—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞...", "info");

        await testCurrentRules();
        log("-".repeat(30), "info");
        await testWithNewRules();

        log("=".repeat(50), "info");
        log("‚úÖ –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞!", "success");
      }

      function clearLog() {
        document.getElementById("log").innerHTML = "";
        updateMainStatus("–õ–æ–≥ –æ—á–∏—â–µ–Ω", "info");
      }

      // –ê–≤—Ç–æ–∑–∞–ø—É—Å–∫ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏
      window.addEventListener("load", () => {
        log("üîß –°—Ç—Ä–∞–Ω–∏—Ü–∞ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏ –∑–∞–≥—Ä—É–∂–µ–Ω–∞", "info");
        log('üí° –ù–∞–∂–º–∏—Ç–µ "–ü–æ–ª–Ω–∞—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞" –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ Firebase', "info");
      });
    </script>
  </body>
</html>
