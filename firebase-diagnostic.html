<!DOCTYPE html>
<html lang="ru">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Firebase Diagnostic</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        padding: 20px;
      }
      .log {
        background: #f5f5f5;
        padding: 10px;
        margin: 10px 0;
        border-radius: 5px;
      }
      .success {
        background: #d4edda;
        color: #155724;
      }
      .error {
        background: #f8d7da;
        color: #721c24;
      }
      .info {
        background: #d1ecf1;
        color: #0c5460;
      }
      button {
        padding: 10px 20px;
        margin: 10px;
        background: #007bff;
        color: white;
        border: none;
        border-radius: 5px;
        cursor: pointer;
      }
      button:hover {
        background: #0056b3;
      }
    </style>
  </head>
  <body>
    <h1>Firebase –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞</h1>
    <button onclick="runFullDiagnostic()">–ó–∞–ø—É—Å—Ç–∏—Ç—å –ø–æ–ª–Ω—É—é –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫—É</button>
    <button onclick="testOperationSave()">–¢–µ—Å—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –æ–ø–µ—Ä–∞—Ü–∏–∏</button>
    <button onclick="checkFirebaseConfig()">
      –ü—Ä–æ–≤–µ—Ä–∏—Ç—å Firebase –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é
    </button>
    <div id="results"></div>

    <!-- Firebase CDN -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>

    <!-- App scripts -->
    <script src="js/firebase-config.js"></script>
    <script src="js/cloud-storage.js"></script>

    <script>
      function log(message, type = "info") {
        const results = document.getElementById("results");
        const div = document.createElement("div");
        div.className = `log ${type}`;
        div.innerHTML = `[${new Date().toLocaleTimeString()}] ${message}`;
        results.appendChild(div);
        console.log(message);
      }

      async function checkFirebaseConfig() {
        log("üîç –ü—Ä–æ–≤–µ—Ä—è–µ–º Firebase –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é...", "info");

        // Check if Firebase is loaded
        if (typeof firebase === "undefined") {
          log("‚ùå Firebase –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω!", "error");
          return false;
        }
        log("‚úÖ Firebase –∑–∞–≥—Ä—É–∂–µ–Ω", "success");

        // Check if config exists
        if (typeof firebaseConfig === "undefined") {
          log("‚ùå firebaseConfig –Ω–µ –Ω–∞–π–¥–µ–Ω!", "error");
          return false;
        }
        log("‚úÖ firebaseConfig –Ω–∞–π–¥–µ–Ω", "success");
        log(`üìã Config: ${JSON.stringify(firebaseConfig, null, 2)}`, "info");

        // Check if Firebase is initialized
        try {
          const app = firebase.app();
          log("‚úÖ Firebase –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–æ", "success");
          log(`üì± App name: ${app.name}`, "info");
        } catch (error) {
          log(`‚ùå Firebase –Ω–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–æ: ${error.message}`, "error");

          // Try to initialize
          try {
            firebase.initializeApp(firebaseConfig);
            log("‚úÖ Firebase –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω –≤—Ä—É—á–Ω—É—é", "success");
          } catch (initError) {
            log(`‚ùå –û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏: ${initError.message}`, "error");
            return false;
          }
        }

        return true;
      }

      async function runFullDiagnostic() {
        log("üöÄ –ù–∞—á–∏–Ω–∞–µ–º –ø–æ–ª–Ω—É—é –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫—É...", "info");

        // 1. Check Firebase config
        const configOk = await checkFirebaseConfig();
        if (!configOk) return;

        // 2. Test authentication
        log("üîê –¢–µ—Å—Ç–∏—Ä—É–µ–º –∞–Ω–æ–Ω–∏–º–Ω—É—é –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—é...", "info");
        try {
          const auth = firebase.auth();
          await auth.signInAnonymously();
          log("‚úÖ –ê–Ω–æ–Ω–∏–º–Ω–∞—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞", "success");
          log(`üë§ User ID: ${auth.currentUser.uid}`, "info");
        } catch (error) {
          log(`‚ùå –û—à–∏–±–∫–∞ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏: ${error.message}`, "error");
          return;
        }

        // 3. Test database connection
        log("üóÑÔ∏è –¢–µ—Å—Ç–∏—Ä—É–µ–º –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö...", "info");
        try {
          const database = firebase.database();
          const testRef = database.ref("diagnostic-test");
          await testRef.set({
            timestamp: Date.now(),
            message: "Test connection",
          });
          log("‚úÖ –ó–∞–ø–∏—Å—å –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö —É—Å–ø–µ—à–Ω–∞", "success");

          const snapshot = await testRef.once("value");
          const data = snapshot.val();
          log(
            `‚úÖ –ß—Ç–µ–Ω–∏–µ –∏–∑ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö —É—Å–ø–µ—à–Ω–æ: ${JSON.stringify(data)}`,
            "success"
          );

          // Clean up
          await testRef.remove();
          log("üßπ –¢–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ —É–¥–∞–ª–µ–Ω—ã", "info");
        } catch (error) {
          log(`‚ùå –û—à–∏–±–∫–∞ —Ä–∞–±–æ—Ç—ã —Å –±–∞–∑–æ–π –¥–∞–Ω–Ω—ã—Ö: ${error.message}`, "error");
          return;
        }

        // 4. Test family path
        log("üë®‚Äçüë©‚Äçüëß‚Äçüë¶ –¢–µ—Å—Ç–∏—Ä—É–µ–º –ø—É—Ç—å —Å–µ–º—å–∏...", "info");
        try {
          const database = firebase.database();
          const familyRef = database.ref("families/artur-valeria-budget/test");
          await familyRef.set({
            timestamp: Date.now(),
            message: "Family path test",
          });
          log("‚úÖ –ó–∞–ø–∏—Å—å –ø–æ –ø—É—Ç–∏ —Å–µ–º—å–∏ —É—Å–ø–µ—à–Ω–∞", "success");

          const snapshot = await familyRef.once("value");
          const data = snapshot.val();
          log(
            `‚úÖ –ß—Ç–µ–Ω–∏–µ –ø–æ –ø—É—Ç–∏ —Å–µ–º—å–∏ —É—Å–ø–µ—à–Ω–æ: ${JSON.stringify(data)}`,
            "success"
          );

          // Clean up
          await familyRef.remove();
          log("üßπ –¢–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ —Å–µ–º—å–∏ —É–¥–∞–ª–µ–Ω—ã", "info");
        } catch (error) {
          log(`‚ùå –û—à–∏–±–∫–∞ —Ä–∞–±–æ—Ç—ã —Å –ø—É—Ç–µ–º —Å–µ–º—å–∏: ${error.message}`, "error");
          return;
        }

        log("üéâ –ü–æ–ª–Ω–∞—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ!", "success");
      }

      async function testOperationSave() {
        log("üí∞ –¢–µ—Å—Ç–∏—Ä—É–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–∏...", "info");

        const configOk = await checkFirebaseConfig();
        if (!configOk) return;

        // Create test operation
        const testOperation = {
          id: Date.now(),
          type: "income",
          amount: 100,
          person: "artur",
          category: "test",
          description: "–¢–µ—Å—Ç–æ–≤–∞—è –æ–ø–µ—Ä–∞—Ü–∏—è",
          date: new Date().toISOString().split("T")[0],
          timestamp: new Date().toISOString(),
          device: { type: "Desktop", browser: "Test" },
        };

        log(
          `üìã –¢–µ—Å—Ç–æ–≤–∞—è –æ–ø–µ—Ä–∞—Ü–∏—è: ${JSON.stringify(testOperation, null, 2)}`,
          "info"
        );

        try {
          // Test EnhancedStorage if available
          if (typeof EnhancedStorage !== "undefined") {
            log("üîç –ò—Å–ø–æ–ª—å–∑—É–µ–º EnhancedStorage...", "info");

            // Test family data save
            const testData = {
              operations: [testOperation],
              categories: { income: ["test"], expense: ["test"] },
              limits: [],
              goals: [],
            };

            await EnhancedStorage.save(testData);
            log("‚úÖ –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —á–µ—Ä–µ–∑ EnhancedStorage —É—Å–ø–µ—à–Ω–æ", "success");

            // Test operation by device save
            await EnhancedStorage.saveOperationByDevice(
              testOperation,
              testOperation.device
            );
            log("‚úÖ –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ –ø–æ —É—Å—Ç—Ä–æ–π—Å—Ç–≤—É —É—Å–ø–µ—à–Ω–æ", "success");
          } else {
            log("‚ùå EnhancedStorage –Ω–µ –Ω–∞–π–¥–µ–Ω", "error");

            // Direct Firebase test
            log("üîÑ –ü—Ä—è–º–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ Firebase...", "info");
            const database = firebase.database();
            const operationRef = database.ref(
              `families/artur-valeria-budget/budgetData/operations/${testOperation.id}`
            );
            await operationRef.set(testOperation);
            log("‚úÖ –ü—Ä—è–º–æ–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ Firebase —É—Å–ø–µ—à–Ω–æ", "success");
          }
        } catch (error) {
          log(`‚ùå –û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –æ–ø–µ—Ä–∞—Ü–∏–∏: ${error.message}`, "error");
          console.error("–î–µ—Ç–∞–ª–∏ –æ—à–∏–±–∫–∏:", error);
        }
      }

      // Auto-run basic check on load
      window.addEventListener("load", () => {
        setTimeout(() => {
          log("üîÑ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ...", "info");
          checkFirebaseConfig();
        }, 1000);
      });
    </script>
  </body>
</html>
