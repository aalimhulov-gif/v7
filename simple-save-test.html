<!DOCTYPE html>
<html>
  <head>
    <title>–ü—Ä–æ—Å—Ç–æ–π —Ç–µ—Å—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è</title>
    <style>
      body {
        font-family: Arial;
        padding: 20px;
      }
      .log {
        padding: 5px;
        margin: 5px 0;
        border-radius: 3px;
      }
      .success {
        background: #d4edda;
      }
      .error {
        background: #f8d7da;
      }
      .info {
        background: #d1ecf1;
      }
      button {
        padding: 10px;
        margin: 5px;
        background: #007bff;
        color: white;
        border: none;
        border-radius: 3px;
      }
    </style>
  </head>
  <body>
    <h1>–ü—Ä–æ—Å—Ç–æ–π —Ç–µ—Å—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –æ–ø–µ—Ä–∞—Ü–∏–π</h1>
    <button onclick="directFirebaseTest()">–ü—Ä—è–º–æ–π —Ç–µ—Å—Ç Firebase</button>
    <button onclick="testEnhancedStorage()">–¢–µ—Å—Ç EnhancedStorage</button>
    <button onclick="checkFirebaseData()">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –≤ Firebase</button>
    <div id="log"></div>

    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
    <script src="js/firebase-config.js"></script>
    <script src="js/config.js"></script>
    <script src="js/utils.js"></script>
    <script src="js/cloud-storage.js"></script>

    <script>
      function log(message, type = "info") {
        const div = document.createElement("div");
        div.className = `log ${type}`;
        div.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
        document.getElementById("log").appendChild(div);
        console.log(message);
      }

      async function directFirebaseTest() {
        log("üî• –ü—Ä—è–º–æ–π —Ç–µ—Å—Ç Firebase...", "info");

        try {
          // Wait for auth
          await firebase.auth().signInAnonymously();
          log("‚úÖ –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞", "success");

          const database = firebase.database();
          const testOperation = {
            id: Date.now(),
            type: "income",
            amount: 500,
            person: "artur",
            category: "test",
            description: "–ü—Ä—è–º–æ–π —Ç–µ—Å—Ç Firebase",
            date: new Date().toISOString().split("T")[0],
            timestamp: new Date().toISOString(),
          };

          // Test saving to family path
          const familyPath =
            "families/artur-valeria-budget/budgetData/operations";
          log(`üìù –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø–æ –ø—É—Ç–∏: ${familyPath}`, "info");

          await database
            .ref(`${familyPath}/${testOperation.id}`)
            .set(testOperation);
          log("‚úÖ –û–ø–µ—Ä–∞—Ü–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞ –ø—Ä—è–º–æ –≤ Firebase!", "success");

          // Test reading back
          const snapshot = await database
            .ref(`${familyPath}/${testOperation.id}`)
            .once("value");
          if (snapshot.exists()) {
            log("‚úÖ –û–ø–µ—Ä–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–æ –ø—Ä–æ—á–∏—Ç–∞–Ω–∞ –∏–∑ Firebase!", "success");
            log(
              `üìä –î–∞–Ω–Ω—ã–µ: ${JSON.stringify(snapshot.val(), null, 2)}`,
              "info"
            );
          } else {
            log("‚ùå –û–ø–µ—Ä–∞—Ü–∏—è –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ –ø—Ä–∏ —á—Ç–µ–Ω–∏–∏!", "error");
          }
        } catch (error) {
          log(`‚ùå –û—à–∏–±–∫–∞ –ø—Ä—è–º–æ–≥–æ —Ç–µ—Å—Ç–∞: ${error.message}`, "error");
        }
      }

      async function testEnhancedStorage() {
        log("üîß –¢–µ—Å—Ç EnhancedStorage...", "info");

        try {
          // Initialize EnhancedStorage
          await EnhancedStorage.save({
            operations: [
              {
                id: Date.now(),
                type: "expense",
                amount: 200,
                person: "valeria",
                category: "test",
                description: "–¢–µ—Å—Ç EnhancedStorage",
                date: new Date().toISOString().split("T")[0],
                timestamp: new Date().toISOString(),
              },
            ],
            categories: { income: ["test"], expense: ["test"] },
            limits: {},
            goals: [],
          });

          log("‚úÖ EnhancedStorage —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ!", "success");

          // Try to load back
          const data = await EnhancedStorage.load();
          if (data && data.operations && data.operations.length > 0) {
            log("‚úÖ EnhancedStorage –∑–∞–≥—Ä—É–∑–∫–∞ —É—Å–ø–µ—à–Ω–∞!", "success");
            log(`üìä –û–ø–µ—Ä–∞—Ü–∏–π –Ω–∞–π–¥–µ–Ω–æ: ${data.operations.length}`, "info");
          } else {
            log("‚ùå EnhancedStorage –Ω–µ –≤–µ—Ä–Ω—É–ª –¥–∞–Ω–Ω—ã–µ!", "error");
          }
        } catch (error) {
          log(`‚ùå –û—à–∏–±–∫–∞ EnhancedStorage: ${error.message}`, "error");
        }
      }

      async function checkFirebaseData() {
        log("üîç –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤—Å–µ –¥–∞–Ω–Ω—ã–µ –≤ Firebase...", "info");

        try {
          await firebase.auth().signInAnonymously();
          const database = firebase.database();

          // Check family path
          const familySnapshot = await database
            .ref("families/artur-valeria-budget")
            .once("value");
          if (familySnapshot.exists()) {
            const familyData = familySnapshot.val();
            log("‚úÖ –ù–∞–π–¥–µ–Ω—ã –¥–∞–Ω–Ω—ã–µ —Å–µ–º—å–∏ –≤ Firebase!", "success");
            log(
              `üìä –°—Ç—Ä—É–∫—Ç—É—Ä–∞: ${JSON.stringify(
                Object.keys(familyData),
                null,
                2
              )}`,
              "info"
            );

            if (familyData.budgetData && familyData.budgetData.operations) {
              const operations = familyData.budgetData.operations;
              log(
                `üí∞ –ù–∞–π–¥–µ–Ω–æ –æ–ø–µ—Ä–∞—Ü–∏–π: ${Object.keys(operations).length}`,
                "info"
              );
              Object.values(operations).forEach((op, index) => {
                log(
                  `  ${index + 1}. ${op.type} - ${op.amount} z≈Ç (${op.person})`,
                  "info"
                );
              });
            } else {
              log("‚ö†Ô∏è –û–ø–µ—Ä–∞—Ü–∏–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã –≤ budgetData", "error");
            }
          } else {
            log("‚ùå –î–∞–Ω–Ω—ã–µ —Å–µ–º—å–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã –≤ Firebase!", "error");
          }

          // Check root level
          const rootSnapshot = await database
            .ref()
            .limitToFirst(10)
            .once("value");
          if (rootSnapshot.exists()) {
            const rootData = rootSnapshot.val();
            log(
              `üìã –ö–æ—Ä–Ω–µ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ: ${JSON.stringify(
                Object.keys(rootData),
                null,
                2
              )}`,
              "info"
            );
          } else {
            log("‚ùå –ö–æ—Ä–Ω–µ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã!", "error");
          }
        } catch (error) {
          log(`‚ùå –û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏: ${error.message}`, "error");
        }
      }

      // Auto-run
      setTimeout(() => {
        log("üöÄ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –∑–∞–ø—É—Å–∫ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏...", "info");
        checkFirebaseData();
      }, 2000);
    </script>
  </body>
</html>
