<!DOCTYPE html>
<html>
  <head>
    <title>Sync Test</title>
    <style>
      body {
        font-family: Arial;
        background: #1a1a1a;
        color: white;
        padding: 20px;
      }
      .test-area {
        background: #2a2a2a;
        padding: 20px;
        margin: 10px 0;
        border-radius: 10px;
      }
      button {
        background: #4caf50;
        color: white;
        border: none;
        padding: 10px 20px;
        margin: 5px;
        border-radius: 5px;
        cursor: pointer;
      }
      .log {
        background: #000;
        padding: 10px;
        border-radius: 5px;
        height: 200px;
        overflow-y: auto;
        font-family: monospace;
        font-size: 12px;
      }
    </style>
  </head>
  <body>
    <h1>üîÑ Sync Test for Family Budget</h1>

    <div class="test-area">
      <h2>Test Family Sync</h2>
      <p>Family ID: <strong>artur-valeria-budget</strong></p>
      <button onclick="testSave()">üíæ Save Test Data</button>
      <button onclick="testLoad()">üì• Load Data</button>
      <button onclick="addOperation()">‚ûï Add Operation</button>
    </div>

    <div class="test-area">
      <h2>Live Log</h2>
      <div id="log" class="log"></div>
    </div>

    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
      import {
        getDatabase,
        ref,
        set,
        onValue,
        get,
      } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";
      import {
        getAuth,
        signInAnonymously,
      } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

      const firebaseConfig = {
        apiKey: "AIzaSyAiB6veVSOVDVz5Nx8xZ9Eb_6dEp7JUTBo",
        authDomain: "budgetami.firebaseapp.com",
        databaseURL:
          "https://budgetami-default-rtdb.europe-west1.firebasedatabase.app",
        projectId: "budgetami",
        storageBucket: "budgetami.firebasestorage.app",
        messagingSenderId: "211374589260",
        appId: "1:211374589260:web:1570eb8b1ddd56a8f64eca",
      };

      const app = initializeApp(firebaseConfig);
      const db = getDatabase(app);
      const auth = getAuth(app);
      const familyId = "artur-valeria-budget";

      function log(msg) {
        const logDiv = document.getElementById("log");
        const time = new Date().toLocaleTimeString();
        logDiv.innerHTML += `[${time}] ${msg}<br>`;
        logDiv.scrollTop = logDiv.scrollHeight;
        console.log(msg);
      }

      // Initialize
      signInAnonymously(auth)
        .then(() => {
          log("‚úÖ Authenticated");

          // Setup real-time listener
          const dataRef = ref(db, `families/${familyId}/budgetData`);
          onValue(dataRef, (snapshot) => {
            if (snapshot.exists()) {
              const data = snapshot.val();
              log(
                `üì° Real-time update: ${
                  data.operations ? data.operations.length : 0
                } operations`
              );
            }
          });
        })
        .catch((error) => {
          log("‚ùå Auth error: " + error.message);
        });

      window.testSave = async function () {
        try {
          const testData = {
            operations: [
              {
                id: Date.now(),
                type: "income",
                amount: 100,
                person: "artur",
                category: "test",
                description: "Test sync",
                date: new Date().toISOString().split("T")[0],
              },
            ],
            goals: [],
            limits: {},
            categories: { income: ["test"], expense: ["test"] },
            settings: { currency: "z≈Ç" },
          };

          await set(ref(db, `families/${familyId}/budgetData`), testData);
          log("üíæ Test data saved");
        } catch (error) {
          log("‚ùå Save error: " + error.message);
        }
      };

      window.testLoad = async function () {
        try {
          const snapshot = await get(
            ref(db, `families/${familyId}/budgetData`)
          );
          if (snapshot.exists()) {
            const data = snapshot.val();
            log(
              `üì• Loaded: ${
                data.operations ? data.operations.length : 0
              } operations`
            );
          } else {
            log("üì≠ No data found");
          }
        } catch (error) {
          log("‚ùå Load error: " + error.message);
        }
      };

      window.addOperation = async function () {
        try {
          // Load current data
          const snapshot = await get(
            ref(db, `families/${familyId}/budgetData`)
          );
          let data = snapshot.exists() ? snapshot.val() : { operations: [] };

          // Add new operation
          const newOp = {
            id: Date.now(),
            type: Math.random() > 0.5 ? "income" : "expense",
            amount: Math.floor(Math.random() * 500) + 10,
            person: Math.random() > 0.5 ? "artur" : "valeria",
            category: "test",
            description: "Test operation " + Date.now(),
            date: new Date().toISOString().split("T")[0],
          };

          data.operations = data.operations || [];
          data.operations.unshift(newOp);

          await set(ref(db, `families/${familyId}/budgetData`), data);
          log(`‚ûï Added ${newOp.type} ${newOp.amount} z≈Ç by ${newOp.person}`);
        } catch (error) {
          log("‚ùå Add error: " + error.message);
        }
      };
    </script>
  </body>
</html>
